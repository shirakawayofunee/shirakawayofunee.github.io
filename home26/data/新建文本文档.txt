(function() {
    // 这里是你带有 span 标签的内容
    const textContent = `

`;

    const typewriterEl = document.getElementById('cmd-typewriter');
    let charIndex = 0;
    let isTyping = false;

    function type() {
        if (charIndex < textContent.length) {
            // 获取当前字符
            const char = textContent.charAt(charIndex);

            // 【关键修复】检测是否是 HTML 标签的开始
            if (char === '<') {
                // 找到标签的结束位置 '>'
                const closingIndex = textContent.indexOf('>', charIndex);
                if (closingIndex !== -1) {
                    // 把整个标签（如 <span class="text-green"> 或 </span>）作为一个整体提取出来
                    const htmlTag = textContent.substring(charIndex, closingIndex + 1);
                    
                    // 直接一次性加入 innerHTML，确保标签结构完整
                    typewriterEl.innerHTML += htmlTag;
                    
                    // 跳过标签内的所有字符，准备打标签后的下一个字
                    charIndex = closingIndex + 1;
                    
                    // 递归调用（不延迟），让标签瞬间生效，紧接着打下一个字
                    type(); 
                    return;
                }
            }

            // 如果不是标签，正常打字
            // 注意：这里必须用 innerHTML，否则 <br> 等标签无法换行
            typewriterEl.innerHTML += char;
            charIndex++;
            
            // --- 下面是原来的速度控制逻辑 ---
            let delay = Math.random() * 40 + 10;
            const prevChar = textContent.charAt(charIndex - 1);
            if (prevChar === '。' || prevChar === '、') {
                delay += 100; 
            }
            
            setTimeout(type, delay);
        }
    }

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isTyping) {
                isTyping = true;
                // 清空内容，防止重复
                typewriterEl.innerHTML = ''; 
                type();
            }
        });
    }, { threshold: 0.1 });

    const wrapper = document.getElementById('terminal-wrapper');
    if (wrapper) {
        observer.observe(wrapper);
    }
})();
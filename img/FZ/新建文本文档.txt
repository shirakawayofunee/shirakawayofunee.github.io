<script>
    var papermaskZoom = 1;
    var currentImgList = []; // 当前查看的图片数组
    var currentImgIndex = 0; // 当前查看的图片索引
    var isAnimating = false; // 防止快速点击导致动画冲突

    // 1. 打开 Modal (入口函数)
    // 注意：需要修改 arrangeWaterfall 里的调用方式，见下方说明
    function openDetailModal(imgList, index) {
        currentImgList = imgList;
        currentImgIndex = index;
        papermaskZoom = 1;

        const container = document.getElementById("imageContainer");
        container.innerHTML = ""; 
        
        const img = document.createElement("img");
        img.src = currentImgList[currentImgIndex].src;
        img.className = "detail-img"; // 默认在中间
        img.id = "activeDetailImg";
        
        container.appendChild(img);

        $(".papermaskDetail").fadeIn(200);
        $(".papermaskDetail").css("display", "flex");
    }

    // 2. 切换图片 (核心重写：双图同步位移)
    function navigateImage(direction) {
        if (isAnimating) return;
        if (!currentImgList || currentImgList.length === 0) return;

        // 计算新索引
        let newIndex = currentImgIndex + direction;
        if (newIndex >= currentImgList.length) newIndex = 0;
        if (newIndex < 0) newIndex = currentImgList.length - 1;

        const container = document.getElementById("imageContainer");
        const currentImg = container.querySelector("img"); // 屏幕上当前的图
        
        // 创建下一张图
        const nextImg = document.createElement("img");
        nextImg.src = currentImgList[newIndex].src;
        nextImg.className = "detail-img";
        // 新图不继承 active ID，动画结束后再给，防止缩放冲突
        
        // --- 第一步：把新图放在屏幕外面 (准备区) ---
        if (direction === 1) {
            // 下一张：新图在右边 (100%)
            nextImg.classList.add("img-pos-right");
        } else {
            // 上一张：新图在左边 (-100%)
            nextImg.classList.add("img-pos-left");
        }
        
        container.appendChild(nextImg);

        // --- 第二步：强制浏览器重绘 (Force Reflow) ---
        // 这一行非常关键！没有它，浏览器会合并样式修改，导致新图直接闪现，没有滑入动画
        nextImg.offsetWidth; 

        // --- 第三步：开始推拉 ---
        isAnimating = true;

        // 给两张图都加上动画过渡属性
        if(currentImg) currentImg.classList.add("img-animating");
        nextImg.classList.add("img-animating");

        // 设定最终位置（利用 requestAnimationFrame 确保下一帧执行）
        requestAnimationFrame(() => {
            // 1. 新图归位 (回到中间 0)
            nextImg.classList.remove("img-pos-right", "img-pos-left");
            
            // 2. 旧图移走
            if (currentImg) {
                // 重置旧图的缩放，防止缩放状态下位移看起来很怪
                currentImg.style.transform = ""; 
                
                if (direction === 1) {
                    // 往左推走 (-100%)
                    currentImg.classList.add("img-pos-left");
                } else {
                    // 往右推走 (100%)
                    currentImg.classList.add("img-pos-right");
                }
            }
        });

        // --- 第四步：动画结束清理 ---
        setTimeout(() => {
            if(currentImg) currentImg.remove();
            
            // 清理新图的动画类，使其变回普通状态
            nextImg.classList.remove("img-animating");
            nextImg.id = "activeDetailImg"; // 赋予ID以供缩放
            
            // 重置缩放倍率变量
            papermaskZoom = 1;
            
            isAnimating = false;
        }, 1600); // 时间需与 CSS transition 0.5s 保持一致

        currentImgIndex = newIndex;
    }

    // 3. 缩放功能 (修改为操作 id="activeDetailImg")
    function handleZoomChange(num) {
        if (num == 1) papermaskZoom += 0.2; // 放大稍微快一点
        if (num == -1) papermaskZoom -= 0.2;
        if (num == 0) papermaskZoom = 1;
        
        if (papermaskZoom > 4) papermaskZoom = 4;
        if (papermaskZoom < 0.5) papermaskZoom = 0.5;
        
        // 只缩放当前激活的图片
        const activeImg = document.getElementById("activeDetailImg");
        if(activeImg) {
            activeImg.style.transform = `scale(${papermaskZoom})`;
        }
    }

    // 4. 下载功能
    function handleDownload() {
        if (!currentImgList[currentImgIndex]) return;
        var imgSrc = currentImgList[currentImgIndex].src;
        var a = document.createElement("a");
        a.href = imgSrc;
        a.download = imgSrc.split('/').pop() || 'image.jpg';
        a.style.display = "none";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    // 5. 关闭 Modal
    function paperShowHide() {
        $(".papermaskDetail").fadeOut(200);
        setTimeout(() => {
             document.getElementById("imageContainer").innerHTML = ""; // 清理内存
        }, 200);
    }

    const galleryImages = [
            { src: "img/XL/zhuxian1.jpg", alt: "メインストーリー", description: "【猫猫バージョン】Lの過去 P1-P6" },
            { src: "img/XL/zhuxian2.webp", alt: "メインストーリー", description: "【メインストーリー/本編】「瞳に映るキミ」" },
            { src: "img/L/L-1.jpg", alt: "メインストーリー/本編", description: "【メインストーリー/本編】Lの過去 P1-P7" },
            { src: "img/XL/zhuxian3.jpg", alt: "メインストーリー", description: "【メインストーリー/本編】（猫猫バージョン）" },
            { src: "img/XL/zhuxian4.webp", alt: "メインストーリー", description: "【メインストーリー/本編】FIN" },
            { src: "img/XL/zhuxian5.jpg", alt: "メインストーリー", description: "【メインストーリー/本編】「後日談」" },
            { src: "img/XL/Xliwu.webp", alt: "メインストーリー", description: "【BAD END-IF】Xからのご挨拶――Lの中で一番重い存在、その死骸" },
            { src: "img/XL/Xliwu2.webp", alt: "メインストーリー", description: "【BAD END-IF】" },
            { src: "img/XL/X表情.jpg", alt: "X表情", description: "X表情" },
            { src: "img/XL/工事中.jpg", alt: "工事中", description: "" }
        ];
        
        const LImages = [        
        { src: "img/L/L0.jpg", alt: "Gallery Image 1", description: "嵐を呼ぶ" },
        { src: "img/L/L1.jpg", alt: "Gallery Image 1", description: "" },
            { src: "img/L/L-1.jpg", alt: "メインストーリー/本編", description: "【本編】メインストーリー" },
            { src: "img/XL/zhuxian1.jpg", alt: "メインストーリー", description: "簡単に希望と平和をもたらす救世主なんて存在しない。いるのは、ただひたすら先を歩く先駆者たちだけだ。" },
            { src: "img/L/L1.webp", alt: "Gallery Image 1", description: "" },
            { src: "img/L/L2.webp", alt: "Gallery Image 2", description: "危険な関系〜" },
            { src: "img/L/L3.webp", alt: "Gallery Image 3", description: "" },
            { src: "img/L/L4.webp", alt: "Gallery Image 4", description: "死と新生" },
            { src: "img/L/L5.webp", alt: "Gallery Image 5", description: "" },
            { src: "img/L/L6.webp", alt: "Gallery Image 6", description: "" },
            { src: "img/L/L7.webp", alt: "Gallery Image 7", description: "「供養」" },
            { src: "img/L/L8.webp", alt: "Gallery Image 8", description: "「孤独」" },
            { src: "img/L/L9.webp", alt: "Gallery Image 9", description: "「憤怒」" },
            { src: "img/L/L10.webp", alt: "Gallery Image 10", description: "" },
            { src: "img/L/L11.webp", alt: "Gallery Image 11", description: "" },
            { src: "img/L/L12.webp", alt: "Gallery Image 12", description: "" },
            { src: "img/L/L13.webp", alt: "Gallery Image 13", description: "" },
            { src: "img/L/L14.webp", alt: "Gallery Image 14", description: "" },
            { src: "img/L/L15.webp", alt: "Gallery Image 15", description: "" },
            { src: "img/L/L16.jpg", alt: "Gallery Image 15", description: "" },
            { src: "img/L/zangli.webp", alt: "Gallery Image 14", description: "N.F.76年" },
        ]; 
        const XImages = [
        { src: "img/X/X0.jpg", alt: "Gallery Image 1", description: "" },
        { src: "img/X/X1.jpg", alt: "Gallery Image 1", description: "" },
            { src: "img/X/X-1.jpg", alt: "メインストーリー/本編", description: "" },
            { src: "img/XX/zhuxian1.jpg", alt: "メインストーリー", description: "" },
            { src: "img/X/X1.webp", alt: "Gallery Image 1", description: "" },
            { src: "img/X/X2.webp", alt: "Gallery Image 2", description: "" },
            { src: "img/X/X3.webp", alt: "Gallery Image 3", description: "" },
            { src: "img/X/X4.webp", alt: "Gallery Image 4", description: "" },
            { src: "img/X/X5.webp", alt: "Gallery Image 5", description: "" },
            { src: "img/X/X6.webp", alt: "Gallery Image 6", description: "" },
            { src: "img/X/X7.webp", alt: "Gallery Image 7", description: "" },
            { src: "img/X/X8.webp", alt: "Gallery Image 8", description: "" },
            { src: "img/X/X9.webp", alt: "Gallery Image 9", description: "" },
            { src: "img/X/X10.webp", alt: "Gallery Image 10", description: "" },
            { src: "img/X/X11.webp", alt: "Gallery Image 11", description: "" },
            { src: "img/X/X12.webp", alt: "Gallery Image 12", description: "" },
            { src: "img/X/X13.webp", alt: "Gallery Image 13", description: "" },
            { src: "img/X/X14.webp", alt: "Gallery Image 14", description: "" },
            { src: "img/X/X15.webp", alt: "Gallery Image 15", description: "" },
            { src: "img/X/X16.jpg", alt: "Gallery Image 15", description: "" },
            { src: "img/X/zangli.webp", alt: "Gallery Image 14", description: "" },

        ];

        const dcImages = [
            { src: "img/XL/00.jpg", alt: "Gallery Image 5", description: "波を起こす者と海面下の者" },
            { src: "img/XL/XL0.jpg", alt: "Gallery Image 1", description: "「N.F.113年8月26日」  401「残花の復仇」" },
            { src: "img/XL/XL1.jpg", alt: "Gallery Image 1", description: "" },
            { src: "img/XL/XL2.jpg", alt: "Gallery Image 2", description: "死の舞踏" },
            { src: "img/XL/XL3.jpg", alt: "Gallery Image 3", description: "手繋ぐ" },
            { src: "img/XL/XL4.jpg", alt: "Gallery Image 4", description: "首を絞める" },
            { src: "img/XL/XL5.jpg", alt: "Gallery Image 5", description: "" },
            { src: "img/XL/XL6.jpg", alt: "Gallery Image 6", description: "" },
            { src: "img/XL/XL7.jpg", alt: "Gallery Image 7", description: "共同の出発点（反逆）" },
            { src: "img/XL/XL8.jpg", alt: "Gallery Image 8", description: "" },
            { src: "img/XL/XL9.jpg", alt: "Gallery Image 8", description: "" },
            { src: "img/XL/XL9-2.jpg", alt: "Gallery Image 8", description: "" },
            { src: "img/XL/IF1.webp", alt: "DC Image 1", description: "禁断の果実をこっそり味わう牧師と悪魔" },
            { src: "img/XL/IF2.webp", alt: "DC Image 2", description: "牧師と悪魔AU" },
            { src: "img/XL/IF3.jpg", alt: "DC Image 3", description: "" },
            { src: "img/XL/IF4.jpg", alt: "DC Image 4", description: "（笑）" },
            { src: "img/XL/掐脖子2.jpg", alt: "Gallery Image 8", description: "首を絞める" },
        ];
        const mangaImages = [
        { src: "img/XL/MH/1.webp", alt: "Manga Image 4", description: "「○○しないと出られない部屋」p1" },
        { src: "img/XL/MH/2.webp", alt: "Manga Image 4", description: "「○○しないと出られない部屋」p2" },
        { src: "img/XL/MH/3.webp", alt: "Manga Image 4", description: "「○○しないと出られない部屋」p3" },
            { src: "img/XL/MH/4.png", alt: "Manga Image 4", description: "「○○しないと出られない部屋」p4" },
            { src: "img/XL/MH/5.png", alt: "Manga Image 4", description: "「○○しないと出られない部屋」p5 Fin." },
        ];
        const catdwImages = [
        { src: "img/XL/cat/dw2.jpg", alt: "Catdw Image 2", description: "猫の群れでは、地位の高い猫が低い猫の毛づくろぎますが、ウサギの群れでは、毛づくろいされることがより高い地位を象徴している。なので、二人とも自分が上だと思っているのです！" },
           
            { src: "img/XL/可爱.jpg", alt: "Halloween", description: "【SD】DEATH NOTE（？" },
            { src: "img/XL/サボテン.jpg", alt: "Halloween", description: "サボテン1" },
            
            { src: "img/XL/Halloween.jpg", alt: "Halloween", description: "【SD】Halloween！" },
            { src: "img/XL/cat/dw1.jpg", alt: "Catdw Image 1", description: "気持ち悪がる猫とあざとウサギ" },
            { src: "img/XL/浇水.jpg", alt: "Catdw Image 3", description: "サボテン2" },
            { src: "img/XL/cat/心满意足.jpg", alt: "Catdw Image 3", description: "" },
            { src: "img/XL/IF7.jpg", alt: "DC Image 7", description: "【SD】" },
            { src: "img/L/sd/浇水3.jpg", alt: "Catdw Image 3", description: "サボテン3" },
            { src: "img/XL/IF5.jpg", alt: "DC Image 5", description: "" },
            { src: "img/XL/IF6.jpg", alt: "DC Image 6", description: "" },
            { src: "img/XL/IF8.webp", alt: "DC Image 6", description: "（？）" },

        ];
        const r18gImages = [
        { src: "img/sutong/XL/01.jpg", alt: "Gallery Image 1", description: "" },
          { src: "img/sutong/XL/02.jpg", alt: "Gallery Image 2", description: "" },
          { src: "img/sutong/XL/03.jpg", alt: "Gallery Image 3", description: "" },
          { src: "img/sutong/XL/04.jpg", alt: "Gallery Image 4", description: "" },
          { src: "img/sutong/XL/05.jpg", alt: "Gallery Image 5", description: "" },
          { src: "img/sutong/XL/06.jpg", alt: "Gallery Image 6", description: "" },
          { src: "img/sutong/XL/07.jpg", alt: "Gallery Image 7", description: "" },
          { src: "img/sutong/XL/08.jpg", alt: "Gallery Image 8", description: "" },
          { src: "img/sutong/XL/09.jpg", alt: "Gallery Image 9", description: "" },
          { src: "img/sutong/XL/10.jpg", alt: "Gallery Image 10", description: "" },
          { src: "img/sutong/XL/11.jpg", alt: "Gallery Image 11", description: "" },
          { src: "img/sutong/XL/12.jpg", alt: "Gallery Image 12", description: "" },
          { src: "img/sutong/XL/13.jpg", alt: "Gallery Image 13", description: "" },
          { src: "img/sutong/XL/14.jpg", alt: "Gallery Image 14", description: "" },
          { src: "img/sutong/XL/15.jpg", alt: "Gallery Image 15", description: "" },
          { src: "img/sutong/XL/16.jpg", alt: "Gallery Image 16", description: "" },
          { src: "img/sutong/XL/17.jpg", alt: "Gallery Image 17", description: "" },
          { src: "img/sutong/XL/18.jpg", alt: "Gallery Image 18", description: "" },
          { src: "img/sutong/XL/19.jpg", alt: "Gallery Image 19", description: "" },
          { src: "img/sutong/XL/20.jpg", alt: "Gallery Image 20", description: "" }


        ];
        const themeImages = [
            { src: "img/DC/ThrillMe/ThrillMe-1.jpg", alt: "DC Image 5", description: "ミュージカル『Thrill Me』" },
            { src: "img/DC/ThrillMe/ThrillMe-2.jpg", alt: "DC Image 5", description: "ミュージカル『Thrill Me』" },
            { src: "img/DC/ThrillMe/ThrillMe-3.jpg", alt: "DC Image 5", description: "ミュージカル『Thrill Me』" },
            { src: "img/DC/ThrillMe/ThrillMe-4.jpg", alt: "DC Image 5", description: "ミュージカル『Thrill Me』" },
            { src: "img/DC/ThrillMe/ThrillMe-5.jpg", alt: "DC Image 5", description: "ミュージカル『Thrill Me』" }
        ];

        const mansionImages = [
        { src: "img/FZ/001.webp", alt: "Mansion Image 01", description: "" },
{ src: "img/FZ/002.webp", alt: "Mansion Image 02", description: "" },
{ src: "img/FZ/003.webp", alt: "Mansion Image 03", description: "" },
{ src: "img/FZ/004.webp", alt: "Mansion Image 04", description: "" },
{ src: "img/FZ/005.webp", alt: "Mansion Image 05", description: "" },
{ src: "img/FZ/006.webp", alt: "Mansion Image 06", description: "" },
{ src: "img/FZ/007.webp", alt: "Mansion Image 07", description: "" },
{ src: "img/FZ/008.webp", alt: "Mansion Image 08", description: "" },
{ src: "img/FZ/009.webp", alt: "Mansion Image 09", description: "" },
{ src: "img/FZ/010.webp", alt: "Mansion Image 10", description: "" },
{ src: "img/FZ/011.webp", alt: "Mansion Image 11", description: "" },
{ src: "img/FZ/012.webp", alt: "Mansion Image 12", description: "" },
{ src: "img/FZ/013.webp", alt: "Mansion Image 13", description: "" },
{ src: "img/FZ/014.webp", alt: "Mansion Image 14", description: "" },
{ src: "img/FZ/015.webp", alt: "Mansion Image 15", description: "" },
{ src: "img/FZ/016.webp", alt: "Mansion Image 16", description: "" },
{ src: "img/FZ/017.webp", alt: "Mansion Image 17", description: "" },
{ src: "img/FZ/018.webp", alt: "Mansion Image 18", description: "" },
{ src: "img/FZ/019.webp", alt: "Mansion Image 19", description: "" },
{ src: "img/FZ/020.webp", alt: "Mansion Image 20", description: "" },
];

        function getArrayByName(name) {
            const map = { 
                "gallery": galleryImages, 
                "L": LImages,     // 新增映射
                "X": XImages,     // 新增映射
                "dc": dcImages, 
                "manga": mangaImages, 
                "catdw": catdwImages, 
                "theme": themeImages, 
                "r18g": r18gImages, 
                "mansion": mansionImages,
            };
            return map[name] || [];
        }

        // 瀑布流生成逻辑
        function arrangeWaterfall(containerId, imageArray) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = "";

        const width = window.innerWidth;
        const columnCount = width > 992 ? 3 : width > 576 ? 2 : 1;

        const columns = Array(columnCount).fill().map(() => {
            const col = document.createElement("div");
            col.className = "gallery-column";
            container.appendChild(col);
            return col;
        });

        if(!imageArray) return;

        imageArray.forEach((image, index) => {
            const item = document.createElement("div");
            item.className = "gallery-item";

            const img = document.createElement("img");
            img.src = image.src; 
            img.alt = image.alt;
            img.className = "holder-img"; 
            
            // [核心修改] 点击时，传递整个数组和当前索引
            img.onclick = function() {
                openDetailModal(imageArray, index);
            };

            const caption = document.createElement("div");
            caption.className = "caption";
            caption.textContent = image.description || "";

            item.appendChild(img);
            item.appendChild(caption);
            columns[index % columnCount].appendChild(item);
        });
    }

    // 键盘支持 (可选：按左右键切换，ESC关闭)
    document.addEventListener('keydown', function(e) {
        if ($(".papermaskDetail").is(":visible")) {
            if (e.key === "ArrowLeft") navigateImage(-1);
            if (e.key === "ArrowRight") navigateImage(1);
            if (e.key === "Escape") paperShowHide();
        }
    });
        // 初始化
        $(document).ready(function() {
            // 默认加载第一个 tab
            arrangeWaterfall("galleryContainer", galleryImages);
          
    // [修改] 定义一个变量来存储定时器 ID
    var hoverTimeout;

    // [修改] 鼠标悬停(Hover)切换 Tab 功能 - 加入延迟防抖
    $('.nav-link').on('mouseenter', function() {
        var _this = this; // 保存当前的 tab 元素上下文
        
        // 设定 500 毫秒 (0.5秒) 后执行切换
        hoverTimeout = setTimeout(function() {
            var tabTrigger = new bootstrap.Tab(_this);
            tabTrigger.show();
        }, 250); 

    }).on('mouseleave', function() {
        // 如果在 0.5 秒内鼠标移出了，就取消这个定时器，不进行切换
        clearTimeout(hoverTimeout);
    });

            // Tab 切换监听
            $('a[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const targetId = $(e.target).attr("href").substring(1);
                const containerId = targetId + "Container";
                const array = getArrayByName(targetId);
                arrangeWaterfall(containerId, array);
            });
        });

        (function() {
            const textContent = `二次創作における恋愛的な解釈については、私もすんなり受け入れます。純粋で美しい愛情を描くのも、不健全で歪んだ、さらには暗く湿った感情を表現するのも、どちらもすごく楽しんで鑑賞しています。
ただ、本家の設定においては、SLは恋愛関係ではないが確かにそこに愛があることは間違いないです。
二人は<span class="text-pink1">師</span><span class="text-Purple">弟</span>、<span class="text-pink1">主</span><span class="text-Purple">従</span>、<span class="text-pink1">母</span><span class="text-Purple">娘</span>、<span class="text-pink1">神</span>と<span class="text-Purple">信徒</span>、革命の<span class="text-blue">戦友</span>であり……こうした様々な立場が重なり合って、彼女たちの間に深いかつ複雑な絆を築き上げています。<span class="text-blue">愛</span>って言葉じゃ正確じゃないけど、<span class="text-blue">この絆を表すなら愛しか出てこない。</span>
それに、Lという人は<span class="text-blue">自由</span>すぎてカッコよすぎる。誰とでも一期一会でパッと火花散らせるけど、誰のそばにも長くは留まらない。<span class="text-blue">愛だってLを縛れない。</span>
`;

            const typewriterEl = document.getElementById('cmd-typewriter');
            let charIndex = 0;
            let isTyping = false;
            
            // [新增] 定义一个变量，专门用来存储当前已经打出的 HTML 字符串
            let currentHTML = ''; 

            function type() {
                if (charIndex < textContent.length) {
                    const char = textContent.charAt(charIndex);

                    // 1. HTML 标签检测逻辑
                    if (char === '<') {
                        const closingIndex = textContent.indexOf('>', charIndex);
                        if (closingIndex !== -1) {
                            // 提取完整标签 (如 <span...>)
                            const htmlTag = textContent.substring(charIndex, closingIndex + 1);
                            
                            // [修改] 存入缓冲区，而不是直接操作 innerHTML
                            currentHTML += htmlTag;
                            typewriterEl.innerHTML = currentHTML;
                            
                            charIndex = closingIndex + 1;
                            type(); // 递归继续
                            return;
                        }
                    }


                    currentHTML += char;
                    typewriterEl.innerHTML = currentHTML;
                    
                    charIndex++;
                    
                    // 3. 打字速度控制
                    let delay = Math.random() * 30 + 10;
                    const prevChar = textContent.charAt(charIndex - 1);
                    if (prevChar === '。' || prevChar === '、') {
                        delay += 100; 
                    }
                    
                    setTimeout(type, delay);
                }
            }

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !isTyping) {
                        isTyping = true;
                        // 重置
                        typewriterEl.innerHTML = '';
                        currentHTML = ''; 
                        type();
                    }
                });
            }, { threshold: 0.1 });

            const wrapper = document.getElementById('terminal-wrapper');
            if (wrapper) {
                observer.observe(wrapper);
            }
        })();
        
    </script>
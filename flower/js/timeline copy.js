window.timelineMsg = [
  {
    date: "N.F.113年",
    text: "レオポルドは自分の余命が短いことを悟り、事前にセヴェロに後事を託した。セヴェロは大きな衝撃を受け、命を延ばせるような情報を必死に探し始めた。",
  },
  {
    date: "N.F.113年6月",
    text: "BR-002事件後、福音地の勢力は新城から撤退し、東区の混乱事件は減少、西区が主要な戦場となる。FACは黒環防衛陣線の構築を計画する。<br>福音地と上庭は互いにスパイを送り込んた。福音地はスパイを通じて上庭の秘密兵器「HUSH」システムの存在を知り、能力者組織「GARDEN」にその破壊を依頼するが、首領レオポルドに拒否される――彼女はより有利な介入のタイミングを待っている。<br>一方、HUSH部隊は福音地を掃除任務を受け、まず福音地と曖昧な関係を持つ能力者組織「GARDEN」を標的にした。HUSH部隊はHUSH-X（以下、X）の指揮下で「GARDEN」への破壊を開始。",
  },
  {
    date: "N.F.113年7月16日",
    text: "ヒーゲル（福音地の幹事の一人）がセヴェロを見つけ、「GARDEN」と「命の延長」を餌に、単瞳のルーンを与え、上庭特使Xの暗殺を頼んだ。",
  },
  {
    date: "N.F.113年7月16日～7月19日",
    text: "高級官僚が次々と襲撃され、「GARDEN」の暗殺リストに載っていると疑われる。",
  },
  {
    date: "N.F.113年7月21日 23:37",
    text: "新城エリカ山荘（Xが一時滞在するリゾート別荘、周辺は「禁閉者」を対象とした天羅地網が張られている）<br><span class=\"cus-key\">刺客<span class=\"cus-target2\">（セヴェロ）</span></span>の襲撃により、X宅が注目を集め、全城に藍雨が48時間降り注ぎ、外部からの大規模襲撃を抑制。",
  },
  {
    date: "N.F.113年7月22日 21:23、「GARDEN」基地",
    text: "レオポルドはセヴェロの誕生日を祝い、緊張を和らげようとするが、セヴェロが謎で姿を消し、失踪した。",
  },
  {
    date: "N.F.113年7月23日 08:05、セヴェロの仕立て屋",
    text: "数日間、セヴェロはエリカ山荘の警備員（禁閉者を含む）と何度も正面衝突した。「GARDEN」に戻って休息しようとした矢先、調査員が訪ねてくる。<br>セヴェロは一瞬心を動かされ、自身と「同じ境遇」に見える調査員を引き込もうとし、「上庭に傷つけられた同類」だと説得、「GARDEN」の首領レオポルドが復讐を助けられると伝えた。しかし、その優しさは強く拒絶され、逆に調査員に裏切られた。最終的にセヴェロは罠に落ち、能力者対策の部隊に制圧され、昏迷状態に陥る。調査員もSan値が限界に達し、一時的に行動不能となる。",
  },
  {
    date: "N.F.113年7月23日 17:10、X宅",
    text: "上庭の「代理」が現れ、Xに新たな任務を伝え、セヴェロの審問を引き継ぐ。",
  },
  {
    date: "N.F.113年7月23日 23:04、X宅の地下室",
    text: "セヴェロが「GARDEN」への忠誠は揺るぎない。数時間にわたる審問は進展せず、代理人はセヴェロの罵倒以外何も得られなかった。そこへXが「生きているセヴェロの方が価値がある」と提案――セヴェロを人質として連れ去れ、レオポルドから福音地の重要情報を引き出すという計画を立てた。代理人はその提案を認める。しかし、「レオポルド」の名を耳にした瞬間、セヴェロは福音地から与えられた単瞳のルーンを起動。ルーンの力が暴走し、彼女は一瞬で制御を失い、監禁を突破して屋敷から逃走し、大混乱を引き起った。",
  },
  {
    date: "N.F.113年7月23日 23:24、山荘内",
    text: "失血多量と狂厄汚染の二重の打撃により、暴走していたセヴェロがついに倒れた。間一髪のところで、レオポルドが駆けつけ、彼女を救い出す。",
  },
  {
    date: "N.F.113年7月24日 00:41、「GARDEN」基地",
    text: "レオポルドは福音地からFAC総司令の暗殺依頼を引き受け、セヴェロは「GARDEN」に戻り体を休養する。<br>序章「Blue rain」終了、つづく。",
  },
  {
    date: "N.F.113年8月7日 23:12",
    text: "可可莉克开始实施她精心筹备的同态复仇计划。安娜尼亚死亡。<br>「沉水之花」案件"
  },
  {
    date: "N.F.113年8月8日 9:00、FAC纪念陵园",
    text: "FAC举行西区作战死难者追悼仪式，总司令发表演讲，缅怀1423名牺牲战士，强调FAC的使命和光明正义。「侦探」代替家人参加，独自承受丧亲之痛，内心对正义的信念动摇。<br>回忆：回忆中她的养姐（或妹妹）拒绝参加追悼会，嘲讽FAC的“英雄”称号，揭示「侦探」的孤独和心理创伤。<br>瑟琳电话：「侦探」接到瑟琳的电话，委托她调查花园刺客的连环袭击案件，担任特派调查员。「侦探」兴奋不已，誓言以“名侦探”之名完成任务。<br>剧情发展：「侦探」的热情被点燃，但她的心理阴影和冲动性格为后续失控埋下伏笔。瑟琳的委托暗示案件与FAC西区作战计划相关，地底势力的阴谋逐渐浮现。"
  },
  {
    date: "N.F.113年8月8日 16:00、新城中央公园落花庭院",
    text: "「侦探」调查“沉水之花”案件，现场发现受害者安娜尼亚被狂厄之花覆盖，呈现非生非死状态。现场布置充满仪式感，暗示禁闭者犯罪。<br>搜证：「侦探」发现狂厄之花的特性（结晶结构、含人类DNA），找到受害者的手机，查到可疑短信（号码043176889），确认凶手内森的身份。<br>对决：内森伪装成治安官，「侦探」发现其监视现场，追捕中暴露内森为女性禁闭者（可可莉克），使用变声器和狂厄之花能力。「侦探」被可可莉克戏弄，抽取生命花芽，险些失控。<br>剧情发展：可可莉克揭示案件与N.F.103年“蚀月行动”有关，挑衅「侦探」的正义感，留下刺杀预告诗。「侦探」的冲动导致可可莉克逃脱，但她找到关键线索，坚定追查真相。"
  },
  {
    date: "N.F.113年8月9日 17:36、锈河东岸",
    text: "「侦探」赶到内森的案发现场，发现其身体完全被狂厄之花取代，现场充满污染。她用蓝雨液体测试墙壁，发现隐藏的尸体残骸，揭露内森的罪行（103年恐吓FAC家属、毁尸灭迹）。<br>失控：「侦探」因心理创伤和狂厄污染失控，M值警报器触发，引来死役袭击。她在战斗中被可可莉克救走，带到花园基地。<br>可可莉克的挑衅：在花园基地，可可莉克揭示「侦探」N.F.104年的刺杀经历，嘲讽她的正义感，试图拉拢她加入花园。「侦探」拒绝，激怒可可莉克，被注射药物逃脱。<br>剧情发展：「侦探」发现案件与103年FAC战败的关联，内森和安娜尼亚都与当年事件有关，动机指向复仇。她的失控和被救经历加深了对花园刺客的复杂情感。"
  },
  {
    date: "N.F.113年8月10日 15:25、新城班彦医学院第一附属医院",
    text: "「侦探」在医院醒来，瑟琳安抚她的情绪，强调正义的存在，重燃她的斗志。「侦探」汇报案件进展，推测花园刺客利用103年事件制造舆论，破坏FAC西区作战计划。<br>米莉亚的警告：「侦探」的养妹米莉亚冷漠警告她小心瑟琳，暗示瑟琳可能不可信。「侦探」未被动摇，继续调查。<br>瑟琳的分析：瑟琳指出花园刺客的仪式感有目的，可能为地底势力破坏FAC计划服务。「侦探」锁定未来慈善基金会为下一个目标。<br>剧情发展：「侦探」重拾信心，但米莉亚的警告为瑟琳的真实身份埋下伏笔。案件的复杂性升级，指向FAC和上庭的权力斗争。"
  },
  {
    date: "N.F.113年8月14日、新城第三大道",
    text: "第三现场（未来慈善基金会）：「侦探」调查基金会案件，发现受害者犹津被杀，但现场12朵狂厄之花不匹配，暗示更多受害者。储物柜中的花笺和灼烧刀痕揭示另一名刺客（蓟）的存在。<br>第四现场（落日俱乐部）：12名基金会元老被狂厄之花聚合，现场被记者破坏，线索缺失。「侦探」推测可可莉克故意制造两个现场掩盖蓟的失败。<br>埋伏蓟：「侦探」利用犹津“复活”的假消息诱捕蓟，成功逮捕她。蓟坦白自己因103年复仇擅自行动，破坏可可莉克的计划。<br>剧情发展：「侦探」破解可可莉克的谜题，揭露蓟的破绽，成功阻止进一步袭击。但可可莉克的真正目标仍未明朗，案件引发舆论风暴，FAC作战计划受阻。"
  },
  {
    date: "N.F.113年8月14日 21:25、未来基金疗养院",
    text: "记者围堵疗养院，质疑犹津“复活”和FAC丑闻，舆论压力加剧。蓟因刺杀失败独自行动，被「侦探」埋伏逮捕。<br>总司令遇袭：FAC总司令遭遇花园刺客袭击（可能为可可莉克），案件升级为针对FAC高层的直接挑战。<br>「侦探」的直觉：「侦探」预感可可莉克的计划未结束，突然被偷袭失去意识，暗示更大的阴谋。<br>剧情发展：案件达到高潮，可可莉克的刺杀预告诗可能指向FAC总司令，地底势力的阴谋逐渐浮出水面。「侦探」的失踪为下一部剧本留下悬念。"
  },
  {
    date: "N.F.113年8月15日 5:25、FAC临时指挥部",
    text: "可可莉克袭击FAC临时指挥部，劫持总司令及多名要员，驾驶装甲车（DS-3864H）向新城逃窜，车内安置狂厄炸弹（威胁1公里范围）。瑟琳指挥HUSH部队追捕，确认「侦探」被绑。<br>「侦探」醒来，拆除简单炸弹，意识到可可莉克无意滥杀。她试图控制车辆，发现刹车被破坏。<br>可可莉克通过对讲机挑衅瑟琳，暗示炸弹已拆除。瑟琳下令黑石英攻击车辆，救出总司令，「侦探」重伤。<br>剧情发展：可可莉克的行动暴露地底情报，瑟琳利用其挑衅测试HUSH系统极限，「侦探」的坚持为后续觉醒埋下伏笔。"
  },
  {
    date: "N.F.113年8月15日 11:32-11:56、FAC临时指挥部",
    text: "可可莉克坐在车前盖上，挑衅「侦探」，暗示炸弹只是诱饵，真正的目标另有其人。瑟琳站在道路中央，启动黑石英武器，准备以“最小代价”净化污染，导致车辆被摧毁。「侦探」试图阻止，但未能改变结局。<br>剧情发展：车辆被黑石英摧毁，司令幸存，但其他人员伤亡惨重。「侦探」重伤，瑟琳冷漠地将其交给MBCC处理，引发克里斯对瑟琳的信任危机。"
  },
  {
    date: "N.F.113年8月17日 14:23、FAC黑环封锁行动联合指挥部",
    text: "FAC黑环封锁行动联合指挥部报告，诱敌方案成功，地底势力因错误情报陷入陷阱。瑟琳继续协调行动，强调情报安全的重要性，同时暗示自己作为“诱饵”的角色。<br>瑟琳通过情报操作误导地底，与黑石英讨论SHP-13回收，确认其与BR-002的联系，计划抢在地底前找到他/她。<br>黑石英质疑罗睺的忠诚，瑟琳为其辩护，暗示信任。<br>可可莉克在花园基地与堇对话，确认加洛法诺恢复，蓟被移交MBCC。她杀死地底上线希格尔，获取空间秘术，彻底切断与地底联系。<br>剧情发展：瑟琳的计划进入关键阶段，可可莉克的背叛动摇地底，FAC作战获得喘息空间，「侦探」的调查为揭露真相铺垫。"
  },
  {
    date: "N.F.113年8月19日 0:00-2:23、锈河近内海辐射区",
    text: "瑟琳继续追捕地底势力，清理狂厄刺客，同时分析地底的空间术式。希格尔（地底高级干部）被可可莉克杀死，揭示可可莉克与地底的决裂。<br>希格尔临死前暴露地底对HUSH系统的了解，透露上庭通过观测庭深入狂厄，瑟琳是核心。希格尔警告瑟琳的危险性。<br>可可莉克获取地底情报，确认空间秘术，计划隐藏花园基地。<br>剧情发展：地底情报网络受重创，可可莉克的行动为FAC作战争取先机，瑟琳的计划接近高潮。"
  },
  {
    date: "N.F.113年8月23日 4:30-4:35、花园基地",
    text: "「侦探」逃出医院，与蓟一起进入花园基地，发现“屠杀”现场。她通过搜证发现现场疑点，推测屠杀是瑟琳伪造的，目的是激怒可可莉克。<br>剧情发展：「侦探」展现了侦探的敏锐观察力，通过花瓣、血迹等细节推断出真相，体现她的成长。"
  },
  {
    date: "N.F.113年8月23日 7:00-17:20、FAC联合指挥部及观测庭",
    text: "FAC基站建设受阻，瑟琳误导地底，争取先机。核心反狂厄基站建设加速，士气高涨。<br>瑟琳与可可莉克在观测庭对峙，诱导其撕裂裂隙，释放感性巨兽（瑟琳被分离的感情），引发HUSH系统崩坏。<br>「侦探」闯入观测庭，揭露瑟琳伪造花园屠杀（人造血浆证据），唤醒可可莉克，带她逃离。<br>瑟琳被狂厄吞噬，HUSH部队启动清除程序，罗睺救下瑟琳，移交修复仓封存。<br>「侦探」重伤，向瑟琳表达复杂情感，决定加入MBCC追查真相。<br>剧情发展：观测庭崩坏标志剧情高潮，瑟琳的背叛暴露，SHP-13的去向成关键悬念。「侦探」和可可莉克的觉醒为后续发展铺路。"
  },
  {
    date: "N.F.113年8月26日、FAC纪念园",
    text: "FAC宣布BR-002封锁成功，防御网限制污染扩散，西区保住。总司令发表讲话，强调英雄牺牲的意义。<br>「侦探」与蓟在陵园对话，确认花园成员存活，蓟承诺与可可莉克寻找同伴，退出刺客生涯。<br>可可莉克找到蓟，确认花园未毁，带着希望继续前行。<br>「侦探」决定加入MBCC，继续追查瑟琳的真相。<br>剧情发展：FAC作战胜利，花园获得新生，「侦探」开启新征程，SHP-13和瑟琳的命运留下悬念。"
  },
  {
    date: "N.F.113年8月26日、上庭内部会议",
    text: "上庭复盘HUSH系统崩坏，确认可可莉克摧毁黑石英，X（瑟琳）被污染。X的“标记”能力疑似反噬，建议暂停使用。<br>上庭计划封存X，重建观测庭，优先追查SHP-13，准备应对地底反扑。<br>罗睺护送瑟琳入修复仓，暗中观察上庭，暗示未来行动。<br>剧情发展：上庭内部出现裂痕，HUSH系统受挫，SHP-13成为争夺焦点，罗睺可能成为新变量。"
  },
  ];

function preloadTimelineImages() {
  const images = [
    './img/timeline/node_normal.png',
    './img/timeline/icon_curr.png',
    './img/timeline/camera.png',
    './img/timeline/title.png',
  ];
  images.forEach(src => {
    const img = new Image();
    img.src = src;
  });
}

function renderTimeline() {
  const timelineScrollable = document.querySelector('#timelineScrollable');
  if (!timelineScrollable) {
    console.error('Error: timelineScrollable element not found!');
    return;
  }

  // 清空现有内容
  timelineScrollable.innerHTML = '';

  // 动态生成 timeline-item
  window.timelineMsg.forEach(item => {
    const timelineItem = document.createElement('div');
    timelineItem.className = 'timeline-item';
    timelineItem.setAttribute('data-mouse', 'small');
    timelineItem.innerHTML = `
      <img src="./img/timeline/node_normal.png" alt="Timeline node" class="timeline-node">
      <div class="timeline-date">${item.date}</div>
      <div class="timeline-text">${item.text}</div>
    `;
    timelineScrollable.appendChild(timelineItem);
  });
}

document.addEventListener('DOMContentLoaded', () => {
  // 预加载图片
  preloadTimelineImages();

  // 渲染时间线
  renderTimeline();

  const timelineScrollable = document.querySelector('#timelineScrollable');
  if (!timelineScrollable) {
    console.error('Error: timelineScrollable element not found!');
    return;
  }

  // 调试：检查滚动区域高度
  console.log('Scroll Height:', timelineScrollable.scrollHeight);
  console.log('Client Height:', timelineScrollable.clientHeight);
  if (timelineScrollable.scrollHeight <= timelineScrollable.clientHeight) {
    console.warn('Warning: Content height is not enough to trigger scrolling! Add more content or reduce container height.');
  }

  // 鼠标滚轮滚动
  timelineScrollable.addEventListener('wheel', (event) => {
    event.preventDefault();
    event.stopPropagation();
    const scrollAmount = event.deltaY * 1.5;
    timelineScrollable.scrollTop += scrollAmount;
    console.log('Wheel scroll triggered, deltaY:', event.deltaY, 'scrollAmount:', scrollAmount);
  }, { passive: false });

  // 鼠标拖拽滚动
  let isDragging = false;
  let startY = 0;
  let startScrollTop = 0;

  timelineScrollable.addEventListener('mousedown', (event) => {
    isDragging = true;
    startY = event.pageY - timelineScrollable.offsetTop;
    startScrollTop = timelineScrollable.scrollTop;
    timelineScrollable.style.cursor = 'grabbing';
    event.preventDefault();
    console.log('Drag start, startY:', startY);
  });

  document.addEventListener('mousemove', (event) => {
    if (!isDragging) return;
    event.preventDefault();
    const y = event.pageY - timelineScrollable.offsetTop;
    const walk = (startY - y) * 1.5;
    timelineScrollable.scrollTop = startScrollTop + walk;
    console.log('Dragging, walk:', walk);
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    timelineScrollable.style.cursor = 'grab';
    console.log('Drag end');
  });

  document.addEventListener('mouseleave', () => {
    isDragging = false;
    timelineScrollable.style.cursor = 'grab';
    console.log('Mouse leave, drag reset');
  });

  // 触摸滑动
  let touchStartY = 0;
  let touchStartScrollTop = 0;

  timelineScrollable.addEventListener('touchstart', (event) => {
    touchStartY = event.touches[0].pageY;
    touchStartScrollTop = timelineScrollable.scrollTop;
    console.log('Touch start, touchStartY:', touchStartY);
  }, { passive: false });

  timelineScrollable.addEventListener('touchmove', (event) => {
    event.preventDefault();
    event.stopPropagation();
    const touchY = event.touches[0].pageY;
    const walk = (touchStartY - touchY) * 1.5;
    timelineScrollable.scrollTop = touchStartScrollTop + walk;
    console.log('Touch move, walk:', walk);
  }, { passive: false });

  // 时间线节点交互
  document.querySelectorAll('.timeline-item').forEach(item => {
    const node = item.querySelector('.timeline-node');
    const originalSrc = './img/timeline/node_normal.png';
    const hoverSrc = './img/timeline/icon_curr.png';
    const originalSize = '14px';
    const hoverSize = '28px';
    const originalLeft = '-7px';
    const hoverLeft = '-14px';
    const originalTop = '5px';
    const hoverTop = '0px';

    // 移动端尺寸和定位
    const isMobile = window.innerWidth <= 768;
    const mobileOriginalSize = '12px';
    const mobileHoverSize = '24px';
    const mobileOriginalLeft = '-6px';
    const mobileHoverLeft = '-12px';
    const mobileOriginalTop = '4px';
    const mobileHoverTop = '0px';

    // 鼠标悬停事件
    item.addEventListener('mouseenter', () => {
      node.src = hoverSrc;
      node.style.width = isMobile ? mobileHoverSize : hoverSize;
      node.style.height = isMobile ? mobileHoverSize : hoverSize;
      node.style.left = isMobile ? mobileHoverLeft : hoverLeft;
      node.style.top = isMobile ? mobileHoverTop : hoverTop;
    });

    // 鼠标离开事件
    item.addEventListener('mouseleave', () => {
      if (!item.classList.contains('active')) {
        node.src = originalSrc;
        node.style.width = isMobile ? mobileOriginalSize : originalSize;
        node.style.height = isMobile ? mobileOriginalSize : originalSize;
        node.style.left = isMobile ? mobileOriginalLeft : originalLeft;
        node.style.top = isMobile ? mobileOriginalTop : originalTop;
      }
    });

    // 点击事件
    item.addEventListener('click', () => {
      document.querySelectorAll('.timeline-item').forEach(otherItem => {
        if (otherItem !== item) {
          otherItem.classList.remove('active');
          const otherNode = otherItem.querySelector('.timeline-node');
          otherNode.src = originalSrc;
          otherNode.style.width = isMobile ? mobileOriginalSize : originalSize;
          otherNode.style.height = isMobile ? mobileOriginalSize : originalSize;
          otherNode.style.left = isMobile ? mobileOriginalLeft : originalLeft;
          otherNode.style.top = isMobile ? mobileOriginalTop : originalTop;
        }
      });
      item.classList.toggle('active');
      node.src = item.classList.contains('active') ? hoverSrc : originalSrc;
      node.style.width = item.classList.contains('active') ? (isMobile ? mobileHoverSize : hoverSize) : (isMobile ? mobileOriginalSize : originalSize);
      node.style.height = item.classList.contains('active') ? (isMobile ? mobileHoverSize : hoverSize) : (isMobile ? mobileOriginalSize : originalSize);
      node.style.left = item.classList.contains('active') ? (isMobile ? mobileHoverLeft : hoverLeft) : (isMobile ? mobileOriginalLeft : originalLeft);
      node.style.top = item.classList.contains('active') ? (isMobile ? mobileHoverTop : hoverTop) : (isMobile ? mobileOriginalTop : originalTop);
    });
  });
});